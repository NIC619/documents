### Casper The Friendly Finality Gadget

這份文件描述以太坊上的權益證明機制（Proof of Stake） - Casper 可能的實現方式。這個提議主要希望能達成具有 (1)高度安全的 finality 及 (2)低成本共識演算法的權益證明機制，同時又不會對現有的工作量證明機制（Proof of Work）的以太坊區塊鏈造成太劇烈的影響。我們將會介紹演算法的運作、如何在部分同步（partially synchronous）環境裡的容錯理論模型中達成 safety 及 liveness 兩個重要特性，接著介紹不同賽局理論裡激勵獎賞的考量、系統如何從超過 1/3 節點下線的情況下復原、藉由鏈下輕量的合作方式從 各種 51% 攻擊中復原。我們將會逐步描述越加複雜的演算法，從核心概念開始，到驗證者輪流方式及經濟激勵獎賞。

### 背景

權益證明機制被視為同時具有巨大潛力及爭議、以安全密碼經濟學、取代工作量證明機制的公有鏈共識機制已經有很長一段時間。工作量證明機制以計算量來衡量經濟共識，而權益證明機制簡單來說則是以[*虛擬挖礦](#)取代實體的 CPU、GPU、ASIC挖礦，其經濟共識則是以系統內 commit 的經濟資源多寡來衡量。

但是早期的權益證明機制受到"[*無成本風險（nothing at stake）](#)"的問題所困擾，這個問題描述的是：如果直接複製工作量證明機制的共識來建立權益證明機制的話，出來的成果會是，當鏈出現分叉時，理性的參與者會選擇兩條鏈都接受，最後導致沒有一條統一的鏈。不像在工作量證明機中，_外部_的資源只能用在其中一條分叉；在簡單的權益證明機制中出現分叉的話，代表兩條分叉上皆有等量的經濟資本的投入，所以驗證者可以用他在 A 鏈上的資本驗證支持 A 鏈，同時又以他在 B 鏈上的資本驗證支持 B 鏈。

工作量證明機制
<img src="https://raw.githubusercontent.com/vbuterin/diagrams/master/powsec.png" width="400px"></img>  
權益證明機制
<img src="https://raw.githubusercontent.com/vbuterin/diagrams/master/possec.png" width="400px"></img>

Casper 建構在 2014 年早期開始的 [Slasher](#) 概念，其概念嘗試透過偵測明顯的 equivocation 行為（一個拜占庭容錯理論中常見的術語，描述的是同時送出相抵觸的訊息來支持不同條分叉）並以經濟上的懲罰來遏止驗證者這麼做。

<img src="https://raw.githubusercontent.com/vbuterin/diagrams/master/slasher1sec.png" width="400px"></img> 

這個概念能解決無成本風險（但有極弱的同步網路環境的假設，後面會介紹的 weak subjectivity）的問題並確保這種權益證明機制至少和工作量證明機制一樣安全。不過我們還能再更進一步 - 很快 Vlad Zamfir 就發現以懲罰為基礎的權益證明機制遠比以獎賞為基礎的權益證明機制還安全，因為這兩者本身並不是對稱的特質。因為獎賞是由協議本身產生，所以其數量受到限制（想像協議設定獎賞為無上限或隨意給，則獎賞的價值將會大大降低）。然而懲罰則遠高得多，甚至可以高到等於協議的全部資本。

這帶來了 _economic finality_ 的概念：

>  如果互相衝突的區塊或狀態（state）也變為不可更改，則存在有證據可以用來對造成這個衝突的相關參與者罰與 X 元的罰金。在這個條件成立下我們可以說一個區塊或狀態可被視為不可更改。其中 X 被稱為終局機制（finality mechanism）裡的 _cryptoeconomic security margin_ 。

但是這種以懲罰為基礎的權益證明機制的形式會遇到另一個問題：“被卡住”的可能：

![](https://cdn-images-1.medium.com/max/800/1*ftuBRQnM8v1kC0Lnvsh3zQ.jpeg)

設計不良的演算法可能會導致沒有區塊能被 finalized ，而且沒有人會因此被懲罰。要設計一個具有精巧的終局特質又同時不會卡住的演算法是個困難的挑戰 - 但至少這個問題已經在拜占庭容錯理論中被研究了數十年了。

像是 PBFT、Paxos 和 [*HoneyBadger BFT](#) 這些演算法都試著完成相似的目標 - 在數群節點（有時稱做程序）間達成共識。一個早期嘗試定義這個問題的方式是利用拜占庭將軍問題：一群將軍試著要擬定出決策來攻打一座城市，但這些將軍中存在某些叛徒。進攻計劃有兩個目標：

A. 所有忠誠的將軍會採用相同的決策
B. [*只有少數的叛徒將沒辦法讓忠誠的將軍採用危險的決策](#)

在現實生活中的共識演算法，要擬定的決策為：operation 執行的順序。

在我們的例子中，我們的目標並不只是在單一輪的共識中決定某個值的結果，而是在持續增長的鏈上不斷出現新的一輪共識。在一個區塊鏈中，每個區塊都包含前一個區塊的雜湊值。所以本質上區塊是和全部的祖先區塊都鏈結在一起。在一個新的區塊上達成共識同時也代表對同一條，整條區塊鏈達成共識。因此，共識演算法不只是必須避免同時在兩個相衝突的區塊都達成共識，還要避免在一個和祖先區塊相衝突的區塊上達成共識。即要在一個區塊上達成共識，該區塊不只要和最新的這一區塊能相容，還要和它所有祖先區塊都相容。

![](https://cdn-images-1.medium.com/max/800/1*ARu6mWJ2_oWXZR0UB13hkQ.jpeg)

接著我們會先介紹 "Minimal Slashing Conditions"，一個具有上述特質，理論上同時也能在其他情況中用來取代 PBFT 的系統。

